# .github/workflows/update-apt-repo.yaml
# PHIÊN BẢN SỬA LỖI TÊN FILE CÓ DẤU CÁCH

name: Build and Deploy APT Repo

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev gpg

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.PRIVATE_KEY }}
          passphrase: ${{ secrets.KEY_PASSPHRASE }}

      - name: Create directory structure
        run: mkdir -p public/debs

      - name: Copy static files and debs
        run: |
          cp -r debs/* public/debs/
          cp style.css public/
          echo "${{ secrets.PUBLIC_KEY }}" > public/KEY.gpg

      - name: Build APT Repository
        run: |
          cd public
          dpkg-scanpackages --multiversion . > Packages
          gzip -c9 Packages > Packages.gz
          apt-ftparchive release . > Release
          gpg --clearsign -u "${{ steps.import_gpg.outputs.email }}" -o InRelease Release
          gpg -abs -u "${{ steps.import_gpg.outputs.email }}" -o Release.gpg Release
          cd ..
      
      - name: Generate professional index.html
        run: |
          # Bắt đầu file HTML
          cat <<EOF > public/index.html
          <!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Repo của ${{ github.repository_owner }}</title><link rel="stylesheet" href="style.css"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"></head><body><div class="container"><header><h1>${{ github.event.repository.name }}</h1><p>Kho lưu trữ APT được host trên GitHub Pages.</p></header><main><section class="installation"><h2>Hướng dẫn cài đặt</h2><pre><code># Thêm GPG Key
          curl -sS --compressed "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/KEY.gpg" | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/${{ github.event.repository.name }}.gpg >/dev/null
          # Thêm Repo
          echo "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/${{ github.event.repository.name }}.gpg] https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/ /" | sudo tee /etc/apt/sources.list.d/${{ github.event.repository.name }}.list
          # Cập nhật
          sudo apt update</code></pre></section><section class="packages"><h2>Danh sách các gói</h2><div class="package-list">
          EOF

          # <<< VÒNG LẶP ĐÃ ĐƯỢC SỬA LẠI ĐỂ AN TOÀN HƠN >>>
          find debs -name "*.deb" -print0 | while IFS= read -r -d '' deb; do
            echo "Processing file: '\$deb'"
            PACKAGE_NAME=\$(dpkg-deb -f "\$deb" Package)
            VERSION=\$(dpkg-deb -f "\$deb" Version)
            DESCRIPTION=\$(dpkg-deb -f "\$deb" Description | head -n 1)
            cat <<EOF >> public/index.html
          <div class="package-item"><div class="package-info"><h3>\$PACKAGE_NAME</h3><p style="color: #aaa; font-size: 0.9em;">Phiên bản: \$VERSION</p><p>\$DESCRIPTION</p></div></div>
          EOF
          done

          # Đóng file HTML
          cat <<EOF >> public/index.html
          </div></section></main><footer><p>&copy; $(date +%Y) ${{ github.repository_owner }}. Hosted on GitHub Pages.</p></footer></div></body></html>
          EOF

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'