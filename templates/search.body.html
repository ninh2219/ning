
<main class="container my-4">
  <h1 class="h4 mb-3">Search</h1>

  <div class="row g-2 align-items-center mb-3">
    <div class="col-md-8">
      <input id="q" class="form-control form-control-lg" placeholder="Nhập từ khóa (package, file, arch, version, mô tả, ...)" autofocus>
    </div>
    <div class="col-md-4 d-flex gap-2">
      <select id="type" class="form-select">
        <option value="">All types</option>
        <option value="deb">DEB only</option>
        <option value="ipa">IPA only</option>
      </select>
      <button id="clearBtn" class="btn btn-outline-secondary">Clear</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead>
        <tr>
          <th>Type</th><th>Name</th><th>Version/Size</th><th>Arch/Hash</th><th>Link</th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="5">Đang tải dữ liệu…</td></tr></tbody>
    </table>
  </div>
</main>

<script>
let DATA = [];
async function load() {
  try {
    const res = await fetch('manifest.json', {cache: 'no-store'});
    const j = await res.json();
    DATA = j.items || [];
    render();
  } catch(e) {
    document.getElementById('rows').innerHTML =
      `<tr><td colspan="5"><em>Lỗi tải manifest: ${e.message}</em></td></tr>`;
  }
}
function norm(s){ return (s||'').toString().toLowerCase(); }
function render(){
  const q = norm(document.getElementById('q').value);
  const t = document.getElementById('type').value;
  const out = [];
  for (const it of DATA) {
    if (t && it.type !== t) continue;
    const hay = [
      it.type, it.package, it.version, it.arch, it.file, it.url, it.description,
      it.sha256, it.category
    ].map(norm).join(' ');
    if (q && !hay.includes(q)) continue;

    if (it.type === 'deb') {
      out.push(`<tr>
        <td><span class="badge text-bg-primary">DEB</span></td>
        <td class="text-break">${it.package||it.file||''}</td>
        <td>${it.version||''}</td>
        <td>${it.arch||''}</td>
        <td>${it.url ? `<a href="${it.url}">Download</a>` : ''}</td>
      </tr>`);
    } else {
      const size = it.size ? (it.size/1e6).toFixed(2)+' MB' : '';
      out.push(`<tr>
        <td><span class="badge text-bg-success">IPA</span></td>
        <td class="text-break">${it.file||''}</td>
        <td>${size}</td>
        <td class="text-break">${it.sha256||''}</td>
        <td>${it.url ? `<a href="${it.url}">Download</a>` : ''}</td>
      </tr>`);
    }
  }
  document.getElementById('rows').innerHTML =
    out.join('') || `<tr><td colspan="5"><em>Không có kết quả.</em></td></tr>`;
}
document.getElementById('q').addEventListener('input', render);
document.getElementById('type').addEventListener('change', render);
document.getElementById('clearBtn').addEventListener('click', () => {
  document.getElementById('q').value = ''; document.getElementById('type').value='';
  render();
});
load();
</script>
