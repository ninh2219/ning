<main class="container my-4">
  <h1 class="h4 mb-3">Search</h1>

  <div class="row g-2 align-items-center mb-3">
    <div class="col-md-8">
      <input id="q" class="form-control form-control-lg"
             placeholder="Nhập từ khóa (package, file, arch, version, mô tả, ...)"
             autofocus>
    </div>
    <div class="col-md-4 d-flex gap-2">
      <select id="type" class="form-select">
        <option value="">All types</option>
        <option value="deb">DEB only</option>
        <option value="ipa">IPA only</option>
      </select>
      <button id="clearBtn" class="btn btn-outline-secondary">Clear</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead>
        <tr>
          <th>Type</th>
          <th>Name</th>
          <th>Version/Size</th>
          <th>Arch/Hash</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="5">Đang tải dữ liệu…</td></tr></tbody>
    </table>
  </div>
</main>

<script>
let DATA = [];

function norm(v){ return (v ?? '').toString().toLowerCase(); }
function fmtMB(n){ return (n ? (n/1e6).toFixed(2) + ' MB' : ''); }

async function load() {
  try {
    const res = await fetch('manifest.json', {cache: 'no-store'});
    const { items=[] } = await res.json();
    // giữ nguyên: items có cả {type:'deb', ...} và {type:'ipa', ...}
    DATA = items;
    render();
  } catch (e) {
    document.getElementById('rows').innerHTML =
      `<tr><td colspan="5"><em>Lỗi tải manifest: ${e.message}</em></td></tr>`;
  }
}

function match(item, q, t){
  if (t && item.type !== t) return false;
  if (!q) return true;
  const hay = [
    item.type, item.package, item.version, item.arch, item.file,
    item.url, item.description, item.sha256, item.category
  ].map(norm).join(' ');
  return hay.includes(q);
}

function badge(type){
  const cls = type === 'deb' ? 'primary' : 'success';
  return `<span class="badge text-bg-${cls}">${type.toUpperCase()}</span>`;
}

function rowOf(item){
  if (item.type === 'deb'){
    const name = item.package || item.file || '';
    const ver  = item.version || '';
    const arch = item.arch || '';
    const link = item.url ? `<a href="${item.url}">Download</a>` : '';
    return `<tr>
      <td>${badge('deb')}</td>
      <td class="text-break">${name}</td>
      <td>${ver}</td>
      <td>${arch}</td>
      <td>${link}</td>
    </tr>`;
  } else {
    const name = item.file || '';
    const size = fmtMB(item.size);
    const hash = item.sha256 || '';
    const link = item.url ? `<a href="${item.url}">Download</a>` : '';
    return `<tr>
      <td>${badge('ipa')}</td>
      <td class="text-break">${name}</td>
      <td>${size}</td>
      <td class="text-break">${hash}</td>
      <td>${link}</td>
    </tr>`;
  }
}

function render(){
  const q = norm(document.getElementById('q').value);
  const t = document.getElementById('type').value; // '' | 'deb' | 'ipa'
  const rows = [];

  // sắp xếp nhẹ: deb lên trước rồi theo tên
  const sorted = [...DATA].sort((a,b)=>{
    if (a.type !== b.type) return a.type.localeCompare(b.type);
    const an = (a.package || a.file || '').toLowerCase();
    const bn = (b.package || b.file || '').toLowerCase();
    return an.localeCompare(bn);
  });

  for (const it of sorted){
    if (!match(it, q, t)) continue;
    rows.push(rowOf(it));
  }
  document.getElementById('rows').innerHTML =
    rows.join('') || `<tr><td colspan="5"><em>Không có kết quả.</em></td></tr>`;
}

document.getElementById('q').addEventListener('input', render);
document.getElementById('type').addEventListener('change', render);
document.getElementById('clearBtn').addEventListener('click', () => {
  document.getElementById('q').value = '';
  document.getElementById('type').value = '';
  render();
});

load();
</script>
